<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow Pro - Generador de Mapas Mentales con IA</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Estilos Generales y Variables CSS */
        :root {
            --primary: #6366f1;
            --secondary: #818cf8;
            --accent: #c084fc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1e1b4b;
            --light: #f8fafc;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f23;
            color: var(--light);
            overflow-x: hidden;
        }
        
        /* Fondo animado para un look din√°mico */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0f0f23, #1a1a3e);
            overflow: hidden;
        }
        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: 50%;
            left: 50%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: pulse 20s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        /* Header y T√≠tulo */
        .header {
            padding: 1.5rem 2rem;
            text-align: center;
            position: relative;
            z-index: 10;
        }
        .header h1 {
            font-size: 3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: glow 3s ease-in-out infinite;
        }
        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        .header p { color: #a5b4fc; font-size: 1.2rem; }
        
        /* Controles Principales (Input y bot√≥n de generar) */
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem auto;
            max-width: 600px;
            padding: 0 2rem;
            flex-wrap: wrap;
        }
        .input-container { flex: 1; min-width: 300px; position: relative; }
        #promptInput {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        #promptInput:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }
        #promptInput::placeholder { color: rgba(255, 255, 255, 0.5); }
        
        /* Estilos de Botones */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary { background: var(--gradient); color: white; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); }
        .btn-primary:hover { box-shadow: 0 6px 30px rgba(99, 102, 241, 0.6); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--light); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4); }
        .btn-warning { background: var(--warning); color: white; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4); }
        .btn-info { background: var(--info); color: white; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); }
        .btn.small-btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }

        /* Opciones de Visualizaci√≥n */
        .options { display: flex; gap: 1rem; justify-content: center; margin: 1rem auto; padding: 0 2rem; flex-wrap: wrap; }
        .option-group { display: flex; gap: 0.5rem; align-items: center; background: rgba(255, 255, 255, 0.05); padding: 0.5rem 1rem; border-radius: 25px; backdrop-filter: blur(10px); }
        .option-group label { font-size: 0.9rem; color: #a5b4fc; }
        select, input[type="color"] { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; cursor: pointer; }
        select option { background: var(--dark); }

        /* Contenedor del Mapa Mental */
        #mindmap {
            width: calc(100% - 4rem);
            height: 60vh;
            margin: 1.5rem auto;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        #mindmap::after {
            content: 'Ingresa un tema y genera tu mapa mental\n\nüí° Tip: Doble clic para editar nodos\nüñ±Ô∏è Clic derecho para m√°s opciones';
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(165, 180, 252, 0.3);
            font-size: 1.2rem; text-align: center;
            pointer-events: none; opacity: 1; transition: opacity 0.3s ease;
            white-space: pre-line; line-height: 1.6; z-index: 1;
        }
        #mindmap.has-content::after { opacity: 0; }
        #mindmap:not(.has-content) .vis-network { display: none; }

        /* Botones de Acci√≥n Debajo del Mapa */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem auto;
            flex-wrap: wrap;
        }
        
        /* Men√∫ Contextual (Clic Derecho) */
        .context-menu {
            position: fixed; background: rgba(30, 27, 75, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--primary);
            border-radius: 10px; padding: 0.5rem 0; z-index: 1000;
            display: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 200px;
        }
        .context-menu-item {
            padding: 0.7rem 1.2rem; cursor: pointer; color: var(--light);
            display: flex; align-items: center; gap: 0.75rem;
            transition: background 0.2s ease; font-size: 0.9rem;
        }
        .context-menu-item:hover { background: rgba(99, 102, 241, 0.2); }
        .context-menu-item.danger:hover { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }

        /* Indicador de Selecci√≥n */
        .selection-indicator {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;
            color: #a5b4fc; border: 1px solid rgba(255, 255, 255, 0.2);
            display: none; animation: slideIn 0.5s ease-out; z-index: 999;
        }
        .selection-indicator.show { display: block; }
        
        /* Indicador de Carga (Spinner) */
        .loading {
            display: none; align-items: center; justify-content: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 15, 35, 0.7); backdrop-filter: blur(5px);
            z-index: 2000;
        }
        .loading-spinner {
            width: 60px; height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Input de archivo oculto para importaci√≥n */
        #importFileInput { display: none; }

        /* Estilos para el modal de ayuda */
        .help-content {
            text-align: left;
            padding: 0 1rem;
        }
        .help-content h2 {
            color: var(--accent);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--secondary);
            padding-bottom: 0.3rem;
        }
        .help-content ul {
            list-style-position: inside;
            padding-left: 0.5rem;
        }
        .help-content li {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .help-content code {
            background-color: rgba(255,255,255,0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 2.2rem; }
            #mindmap { height: 55vh; width: calc(100% - 2rem); }
            .controls, .options, .action-buttons { padding: 0 1rem; }
            .btn { padding: 0.8rem 1.5rem; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <header class="header">
        <h1>MindFlow Pro</h1>
        <p>Transforma tus ideas en mapas mentales interactivos con IA</p>
    </header>
    
    <div class="controls">
        <div class="input-container">
            <input type="text" id="promptInput" placeholder="Ingresa tu idea central (ej: La c√©lula y sus partes)">
        </div>
        <button class="btn btn-primary" onclick="generateMindMap()">
            ‚ö° Generar MindFlow
        </button>
    </div>
    
    <div class="options">
        <div class="option-group">
            <label>Tema:</label>
            <select id="themeSelect" onchange="updateTheme()">
                <option value="cosmic">C√≥smico</option>
                <option value="nature">Natural</option>
                <option value="tech">Tecnol√≥gico</option>
                <option value="minimal">Minimalista</option>
            </select>
        </div>
        <div class="option-group">
            <label>Disposici√≥n:</label>
            <select id="layoutSelect" onchange="updateLayout()">
                <option value="hierarchical">Jer√°rquico</option>
                <option value="radial">Radial</option>
            </select>
        </div>
        <div class="option-group">
            <label>Color Ppal:</label>
            <input type="color" id="colorPicker" value="#6366f1" onchange="updateColors()">
        </div>
    </div>
    
    <div id="mindmap"></div>
    
    <div class="action-buttons">
        <button class="btn btn-secondary small-btn" onclick="document.getElementById('importFileInput').click()">üìÇ Importar JSON</button>
        <button class="btn btn-secondary small-btn" onclick="exportJSON()">üíæ Exportar JSON</button>
        <button class="btn btn-secondary small-btn" onclick="exportPNG()">üì∑ Exportar PNG</button>
        <button class="btn btn-info small-btn" onclick="togglePhysics()">‚öõÔ∏è F√≠sica ON/OFF</button>
        <button class="btn btn-danger small-btn" onclick="resetMap()">üîÑ Reiniciar</button>
        <button class="btn btn-warning small-btn" onclick="showHelpModal()">‚ùì Ayuda</button>
    </div>
    
    <!-- Men√∫ contextual (inicialmente oculto) -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editSelectedNode()">‚úèÔ∏è Editar Nodo</div>
        <div class="context-menu-item" onclick="addChildNode()">‚ûï A√±adir Hijo</div>
        <div class="context-menu-item" onclick="expandNodeWithAI()">üß† Expandir con IA</div>
        <div class="context-menu-item" onclick="addIconToNode()">üôÇ A√±adir Icono/Emoji</div>
        <div class="context-menu-item" onclick="changeNodeColor()">üé® Cambiar Color</div>
        <div class="context-menu-item danger" onclick="deleteSelectedNode()">üóëÔ∏è Eliminar</div>
    </div>
    
    <div class="loading"><div class="loading-spinner"></div></div>
    <div class="selection-indicator" id="selectionIndicator"></div>
    <input type="file" id="importFileInput" accept=".json" onchange="handleFileImport(event)">
    
    <script>
        // --- VARIABLES GLOBALES Y ESTADO DE LA APLICACI√ìN ---
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let nodeIdCounter = 0;
        let selectedNode = null;
        let physicsEnabled = true;
        
        // --- TEMAS Y CONFIGURACI√ìN VISUAL ---
        const themes = {
            cosmic: { node: { background: '#6366f1', border: '#818cf8', font: '#ffffff' }, edge: { color: '#818cf8', highlight: '#c084fc' } },
            nature: { node: { background: '#10b981', border: '#34d399', font: '#ffffff' }, edge: { color: '#34d399', highlight: '#6ee7b7' } },
            tech: { node: { background: '#f59e0b', border: '#fbbf24', font: '#1f2937' }, edge: { color: '#fbbf24', highlight: '#fde68a' } },
            minimal: { node: { background: '#e5e7eb', border: '#9ca3af', font: '#1f2937' }, edge: { color: '#9ca3af', highlight: '#6b7280' } }
        };
        let currentTheme = themes.cosmic;

        // --- INICIALIZACI√ìN Y EVENTOS DE RED ---
        function initNetwork() {
            const container = document.getElementById('mindmap');
            const data = { nodes, edges };
            const options = {
                nodes: {
                    shape: 'box', borderWidth: 2, borderWidthSelected: 3,
                    font: { size: 16, face: 'Segoe UI, Arial, sans-serif' },
                    shadow: { enabled: true, size: 10, x: 5, y: 5 },
                    mass: 1.5
                },
                edges: {
                    width: 2,
                    smooth: { type: 'dynamic' },
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                    shadow: true
                },
                layout: {
                    hierarchical: { enabled: true, direction: 'UD', sortMethod: 'directed', nodeSpacing: 150, levelSeparation: 150 }
                },
                physics: {
                    enabled: true,
                    hierarchicalRepulsion: { nodeDistance: 180 }
                },
                interaction: {
                    hover: true, tooltipDelay: 200, hideEdgesOnDrag: true, selectConnectedEdges: false, navigationButtons: true
                },
                manipulation: { enabled: false }
            };
            network = new vis.Network(container, data, options);
            setupNetworkEvents();
        }

        function setupNetworkEvents() {
            network.on('doubleClick', params => {
                if (params.nodes.length > 0) editNode(params.nodes[0]);
            });

            network.on('oncontext', params => {
                params.event.preventDefault();
                hideContextMenu();
                if (params.nodes.length > 0) {
                    selectedNode = params.nodes[0];
                    network.selectNodes([selectedNode]);
                    showContextMenu(params.event.clientX, params.event.clientY);
                }
            });

            network.on('click', params => {
                hideContextMenu();
                updateSelection(params.nodes);
            });
            
            // Guardar autom√°ticamente al arrastrar un nodo
            network.on('dragEnd', () => saveMapToLocalStorage());

            document.addEventListener('click', e => {
                if (!document.getElementById('contextMenu').contains(e.target)) {
                    hideContextMenu();
                }
            });
            
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // --- L√ìGICA DE LA IA (GEMINI API) ---
        
        /**
         * Genera un mapa mental completo basado en el prompt del usuario.
         */
        async function generateMindMap() {
            const userPrompt = document.getElementById('promptInput').value.trim();
            if (!userPrompt) {
                showToast('warning', 'Campo vac√≠o', 'Por favor, ingresa una idea o tema.');
                return;
            }
            
            resetMapData();
            document.querySelector('.loading').style.display = 'flex';

            const structuredPrompt = `Eres un experto creando mapas mentales claros y concisos. Basado en el tema central "${userPrompt}", genera una estructura de mapa mental. El mapa debe tener un nodo central (nivel 0), varios nodos principales (nivel 1) y algunos sub-nodos (nivel 2). Devuelve la respuesta EXCLUSIVAMENTE en formato JSON, siguiendo el esquema proporcionado. El nodo con id 0 debe ser el nodo central con el tema "${userPrompt}". Aseg√∫rate de que los IDs sean √∫nicos y secuenciales empezando en 0. No incluyas explicaciones ni texto adicional, solo el objeto JSON.`;
            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "nodes": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "id": { "type": "NUMBER" },
                                "label": { "type": "STRING" },
                                "level": { "type": "NUMBER" }
                            },
                            required: ["id", "label", "level"]
                        }
                    },
                    "edges": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: { "from": { "type": "NUMBER" }, "to": { "type": "NUMBER" } },
                            required: ["from", "to"]
                        }
                    }
                },
                required: ["nodes", "edges"]
            };

            try {
                const mapData = await callGeminiAPI(structuredPrompt, jsonSchema);
                const themedNodes = mapData.nodes.map(node => ({
                    ...node,
                    ...getNodeColor(node.level),
                    font: { size: node.level === 0 ? 22 : (node.level === 1 ? 16 : 14) },
                    ...(node.level === 0 && {size: 40, borderWidth: 3, mass: 3})
                }));
                
                nodeIdCounter = Math.max(-1, ...themedNodes.map(n => n.id)) + 1;
                nodes.add(themedNodes);
                edges.add(mapData.edges);
                
                document.getElementById('mindmap').classList.add('has-content');
                network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
                showToast('success', '¬°Mapa generado con IA!', 'Tu mapa mental est√° listo.');
                saveMapToLocalStorage();
            } catch (error) {
                console.error("Error al generar el mapa mental:", error);
                showToast('error', 'Error de Generaci√≥n', 'No se pudo crear el mapa. Revisa la consola para m√°s detalles.');
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        /**
         * Expande un nodo seleccionado con ideas generadas por la IA.
         */
        async function expandNodeWithAI() {
            if (!selectedNode) return;

            const parentNode = nodes.get(selectedNode);
            document.querySelector('.loading').style.display = 'flex';

            const structuredPrompt = `Eres un asistente creativo de mapas mentales. Para el concepto central "${parentNode.label}", genera entre 3 y 5 ideas o sub-temas relacionados para expandirlo. Devuelve la respuesta EXCLUSIVAMENTE en formato JSON con una lista de los nuevos conceptos. El JSON debe seguir el esquema proporcionado. No incluyas el nodo padre en la respuesta, solo los nuevos nodos hijos.`;
            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "nuevas_ideas": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: { "label": { type: "STRING" } },
                            required: ["label"]
                        }
                    }
                },
                required: ["nuevas_ideas"]
            };

            try {
                const result = await callGeminiAPI(structuredPrompt, jsonSchema);
                const childLevel = (parentNode.level || 0) + 1;
                
                result.nuevas_ideas.forEach(idea => {
                    const childId = nodeIdCounter++;
                    nodes.add({ id: childId, label: idea.label, level: childLevel, ...getNodeColor(childLevel) });
                    edges.add({ from: selectedNode, to: childId });
                });

                showToast('success', 'Nodo expandido', `Se a√±adieron ${result.nuevas_ideas.length} ideas nuevas.`);
                saveMapToLocalStorage();
                network.fit({ nodes: [selectedNode], animation: true });

            } catch (error) {
                 console.error("Error al expandir el nodo con IA:", error);
                showToast('error', 'Error de Expansi√≥n', 'No se pudieron generar las ideas.');
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        /**
         * Funci√≥n gen√©rica para llamar a la API de Gemini.
         */
        async function callGeminiAPI(prompt, schema) {
            const apiKey = ""; // La API Key se inyectar√° en el entorno de ejecuci√≥n. No es necesario a√±adirla aqu√≠.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`Error de la API: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                throw new Error("Respuesta inesperada o vac√≠a de la API.");
            }

            return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        // --- MANIPULACI√ìN DE NODOS Y ARISTAS (MANUAL) ---
        async function addNode() {
            const { value: label } = await Swal.fire({
                title: 'A√±adir Nuevo Nodo', input: 'text', inputPlaceholder: 'Texto del nuevo nodo...',
                showCancelButton: true, confirmButtonText: 'Crear Nodo', ...getSwalTheme()
            });
            if (label) {
                const newId = nodeIdCounter++;
                const parentSelection = network.getSelectedNodes();
                const level = parentSelection.length > 0 ? (nodes.get(parentSelection[0]).level || 0) + 1 : 0;
                
                nodes.add({ id: newId, label, level, ...getNodeColor(level) });

                if (parentSelection.length > 0) {
                    edges.add({from: parentSelection[0], to: newId});
                }
                
                if (nodes.length === 1) document.getElementById('mindmap').classList.add('has-content');
                saveMapToLocalStorage();
            }
        }
        
        async function editNode(nodeId) {
            const node = nodes.get(nodeId);
            const { value: newLabel } = await Swal.fire({
                title: 'Editar Nodo', input: 'text', inputValue: node.label,
                showCancelButton: true, confirmButtonText: 'Guardar', ...getSwalTheme()
            });
            if (newLabel && newLabel !== node.label) {
                 nodes.update({ id: nodeId, label: newLabel });
                 saveMapToLocalStorage();
            }
        }
        
        async function addChildNode() {
            if (!selectedNode) return;
            const { value: label } = await Swal.fire({
                title: `A√±adir hijo a "${nodes.get(selectedNode).label}"`, input: 'text', inputPlaceholder: 'Texto del nodo hijo...',
                showCancelButton: true, confirmButtonText: 'A√±adir', ...getSwalTheme()
            });
            if (label) {
                const parentNode = nodes.get(selectedNode);
                const childLevel = (parentNode.level || 0) + 1;
                const childId = nodeIdCounter++;
                nodes.add({ id: childId, label, level: childLevel, ...getNodeColor(childLevel) });
                edges.add({ from: selectedNode, to: childId });
                saveMapToLocalStorage();
            }
        }
        
        function deleteSelectedNodes() {
            const selection = network.getSelection();
            if (selection.nodes.length === 0 && selection.edges.length === 0) {
                showToast('warning', 'Nada seleccionado', 'Selecciona uno o m√°s nodos/aristas.');
                return;
            }
            Swal.fire({
                title: '¬øEst√°s seguro?', text: `Se eliminar√°n ${selection.nodes.length} nodos y sus conexiones.`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                confirmButtonText: 'S√≠, eliminar', cancelButtonText: 'Cancelar', ...getSwalTheme()
            }).then(result => {
                if (result.isConfirmed) {
                    nodes.remove(selection.nodes);
                    // vis-network se encarga de las aristas conectadas
                    if (nodes.length === 0) document.getElementById('mindmap').classList.remove('has-content');
                    saveMapToLocalStorage();
                }
            });
        }
        
        async function addIconToNode() {
            if(!selectedNode) return;
            const node = nodes.get(selectedNode);
            const { value: emoji } = await Swal.fire({
                title: 'A√±adir Icono/Emoji',
                input: 'text',
                inputPlaceholder: 'Pega un emoji aqu√≠ (ej: ‚ú®)',
                ...getSwalTheme()
            });

            if (emoji) {
                // Elimina emojis anteriores para no acumularlos
                const plainLabel = node.label.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu, '').trim();
                nodes.update({ id: selectedNode, label: `${emoji} ${plainLabel}` });
                saveMapToLocalStorage();
            }
        }

        function handleKeyboardShortcuts(event) {
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(event.target.tagName)) return;
            switch(event.key) {
                case 'Delete':
                case 'Backspace':
                    event.preventDefault();
                    deleteSelectedNodes();
                    break;
                case 'Escape':
                    network.unselectAll();
                    break;
                case 'Enter':
                    if (network.getSelectedNodes().length === 1) {
                        event.preventDefault();
                        editNode(network.getSelectedNodes()[0]);
                    }
                    break;
            }
        }

        // --- PERSISTENCIA Y GESTI√ìN DE DATOS ---

        function saveMapToLocalStorage() {
            if (nodes.length > 0) {
                const mapData = {
                    nodes: nodes.get({ fields: ['id', 'label', 'level', 'color', 'font'] }),
                    edges: edges.get(),
                    nodeIdCounter: nodeIdCounter
                };
                localStorage.setItem('mindflowData', JSON.stringify(mapData));
            } else {
                localStorage.removeItem('mindflowData');
            }
        }

        function loadMapFromLocalStorage() {
            const savedData = localStorage.getItem('mindflowData');
            if (savedData) {
                try {
                    const mapData = JSON.parse(savedData);
                    nodes.add(mapData.nodes);
                    edges.add(mapData.edges);
                    nodeIdCounter = mapData.nodeIdCounter || (Math.max(-1, ...mapData.nodes.map(n => n.id)) + 1);
                    document.getElementById('mindmap').classList.add('has-content');
                    network.fit();
                    showToast('info', 'Mapa cargado', 'Se ha restaurado tu sesi√≥n anterior.');
                } catch(e) {
                    console.error("Error al cargar datos locales, reiniciando.", e);
                    localStorage.removeItem('mindflowData');
                }
            }
        }

        function exportJSON() {
            if (nodes.length === 0) {
                showToast('warning', 'Mapa vac√≠o', 'No hay nada que exportar.');
                return;
            }
            const mapData = {
                nodes: nodes.get(),
                edges: edges.get(),
                nodeIdCounter: nodeIdCounter
            };
            const dataStr = JSON.stringify(mapData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const promptName = document.getElementById('promptInput').value.trim().replace(/\s+/g, '_') || 'mapa_mental';
            link.download = `MindFlow_${promptName}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const mapData = JSON.parse(e.target.result);
                    if (mapData.nodes && mapData.edges) {
                        resetMapData();
                        nodes.add(mapData.nodes);
                        edges.add(mapData.edges);
                        nodeIdCounter = mapData.nodeIdCounter || (Math.max(-1, ...mapData.nodes.map(n => n.id)) + 1);
                        document.getElementById('mindmap').classList.add('has-content');
                        network.fit();
                        showToast('success', 'Mapa importado', 'El mapa se ha cargado correctamente.');
                        saveMapToLocalStorage();
                    } else {
                        throw new Error("El archivo JSON no tiene el formato correcto.");
                    }
                } catch (error) {
                    console.error("Error al importar JSON:", error);
                    showToast('error', 'Error de importaci√≥n', 'El archivo no es un mapa mental v√°lido.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input para poder cargar el mismo archivo de nuevo
        }

        // --- PERSONALIZACI√ìN VISUAL ---
        function updateTheme() {
            currentTheme = themes[document.getElementById('themeSelect').value];
            document.getElementById('colorPicker').value = currentTheme.node.background;
            applyThemeToAll();
        }

        function updateLayout() {
            const layout = document.getElementById('layoutSelect').value;
            network.setOptions({
                layout: { hierarchical: { enabled: layout === 'hierarchical' } },
                physics: { 
                    enabled: true,
                    solver: layout === 'radial' ? 'forceAtlas2Based' : 'hierarchicalRepulsion'
                }
            });
        }

        function updateColors() {
            currentTheme.node.background = document.getElementById('colorPicker').value;
            applyThemeToAll();
        }

        function applyThemeToAll() {
            nodes.forEach(node => {
                nodes.update({ id: node.id, ...getNodeColor(node.level) });
            });
            edges.forEach(edge => {
                edges.update({ id: edge.id, color: { color: currentTheme.edge.color, highlight: currentTheme.edge.highlight } });
            });
            saveMapToLocalStorage();
        }
        
        async function changeNodeColor() {
            if (!selectedNode) return;
            const { value: color } = await Swal.fire({
                title: 'Elige un color para el nodo', input: 'color',
                inputValue: nodes.get(selectedNode).color.background,
                showCancelButton: true, confirmButtonText: 'Aplicar', ...getSwalTheme()
            });
            if (color) {
                nodes.update({ id: selectedNode, color: { background: color, border: color } });
                saveMapToLocalStorage();
            }
        }
        
        function getNodeColor(level = 0) {
            const opacities = ['', 'dd', 'aa', '88'];
            const opacity = opacities[level] || '66';
            return {
                color: {
                    background: currentTheme.node.background + opacity,
                    border: currentTheme.node.border
                },
                font: { color: currentTheme.node.font }
            };
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            network.setOptions({ physics: { enabled: physicsEnabled } });
            showToast('info', 'F√≠sica', `Simulaci√≥n ${physicsEnabled ? 'activada' : 'desactivada'}.`);
        }

        // --- UTILIDADES Y UI HELPERS ---
        function exportPNG() {
            if (nodes.length === 0) {
                showToast('warning', 'Mapa vac√≠o', 'No hay nada que exportar.');
                return;
            }
            const container = document.getElementById('mindmap');
            showToast('info', 'Exportando...', 'Generando imagen PNG, por favor espera.');
            html2canvas(container.getElementsByTagName('canvas')[0], {
                backgroundColor: '#0f0f23', scale: 2, logging: false, useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `MindFlow-${document.getElementById('promptInput').value || 'map'}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error("Error al exportar a PNG:", err);
                showToast('error', 'Error de Exportaci√≥n', 'No se pudo generar la imagen.');
            });
        }
        
        function resetMapData() {
            nodes.clear();
            edges.clear();
            nodeIdCounter = 0;
            document.getElementById('mindmap').classList.remove('has-content');
        }

        function resetMap() {
            Swal.fire({
                title: '¬øReiniciar Mapa?', text: "Se perder√° todo el mapa actual. Esta acci√≥n no se puede deshacer.",
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                confirmButtonText: 'S√≠, reiniciar', cancelButtonText: 'Cancelar', ...getSwalTheme()
            }).then(result => {
                if (result.isConfirmed) {
                    resetMapData();
                    localStorage.removeItem('mindflowData');
                    document.getElementById('promptInput').value = '';
                }
            });
        }

        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            selectedNode = null;
        }

        function updateSelection(nodeIds) {
            const indicator = document.getElementById('selectionIndicator');
            if (nodeIds.length > 0) {
                const nodeText = nodeIds.length === 1 ? `Nodo: "${nodes.get(nodeIds[0]).label}"` : `${nodeIds.length} nodos`;
                indicator.textContent = `Seleccionado: ${nodeText}`;
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }
        
        function editSelectedNode() { if (selectedNode) editNode(selectedNode); }
        function deleteSelectedNode() { if (selectedNode) { network.selectNodes([selectedNode]); deleteSelectedNodes(); } }
        
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
            didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; }
        });
        function showToast(icon, title, text = '') {
            Toast.fire({ icon, title, text, background: '#1e1b4b', color: '#f8fafc' });
        }
        function getSwalTheme() { return { background: '#1e1b4b', color: '#f8fafc', confirmButtonColor: '#6366f1', cancelButtonColor: '#6b7280' }; }
        
        // --- FUNCI√ìN DE AYUDA ---
        function showHelpModal() {
            const helpHtml = `
            <div class="help-content">
                <h2>ü§ñ Funciones con IA</h2>
                <ul>
                    <li><strong>Generar MindFlow:</strong> Escribe una idea central y la IA crear√° un mapa mental completo para ti.</li>
                    <li><strong>Expandir con IA:</strong> Haz clic derecho en un nodo y selecciona 'üß† Expandir con IA' para generar ideas secundarias autom√°ticamente.</li>
                </ul>

                <h2>‚úçÔ∏è Edici√≥n Manual (Men√∫ Clic Derecho)</h2>
                <ul>
                    <li><strong>Editar Nodo:</strong> Cambia el texto de cualquier nodo. Tambi√©n puedes hacer doble clic.</li>
                    <li><strong>A√±adir Hijo:</strong> Crea un nuevo nodo conectado al que seleccionaste.</li>
                    <li><strong>A√±adir Icono/Emoji:</strong> Personaliza tus nodos con emojis para hacerlos m√°s visuales.</li>
                    <li><strong>Cambiar Color:</strong> Elige un color espec√≠fico para un nodo.</li>
                    <li><strong>Eliminar:</strong> Borra el nodo seleccionado y sus conexiones.</li>
                </ul>

                <h2>‚öôÔ∏è Controles Generales</h2>
                <ul>
                    <li><strong>Importar/Exportar JSON:</strong> Guarda tu trabajo en un archivo <code>.json</code> o carga uno existente. ¬°Ideal para copias de seguridad!</li>
                    <li><strong>Exportar PNG:</strong> Guarda una imagen de alta calidad de tu mapa mental.</li>
                    <li><strong>Reiniciar:</strong> Borra todo el mapa y empieza de cero.</li>
                    <li><strong>F√≠sica ON/OFF:</strong> Activa o desactiva la organizaci√≥n autom√°tica de nodos. Desact√≠vala para colocar los nodos manualmente con precisi√≥n antes de exportar.</li>
                    <li><strong>Persistencia Autom√°tica:</strong> ¬°Tu trabajo se guarda en el navegador! Si recargas la p√°gina, tu mapa seguir√° aqu√≠.</li>
                </ul>
            </div>
            `;

            Swal.fire({
                title: 'Gu√≠a de Ayuda de MindFlow',
                html: helpHtml,
                width: '80%',
                ...getSwalTheme()
            });
        }

        // --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
        window.onload = () => {
            initNetwork();
            loadMapFromLocalStorage();
            document.getElementById('promptInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') generateMindMap();
            });
        };
    </script>
</body>
</html>
