<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow Pro - Generador de Mapas Mentales Multi-IA</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Estilos Generales y Variables CSS */
        :root {
            --primary: #6366f1;
            --secondary: #818cf8;
            --accent: #c084fc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1e1b4b;
            --light: #f8fafc;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f23;
            color: var(--light);
            overflow-x: hidden;
        }
        
        /* Fondo animado para un look din√°mico */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0f0f23, #1a1a3e);
            overflow: hidden;
        }
        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: 50%;
            left: 50%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: pulse 20s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        /* Header y T√≠tulo */
        .header {
            padding: 1.5rem 2rem;
            text-align: center;
            position: relative;
            z-index: 10;
        }
        .header h1 {
            font-size: 3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: glow 3s ease-in-out infinite;
        }
        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        .header p { color: #a5b4fc; font-size: 1.2rem; }
        .help-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
        }
        
        /* Controles Principales (Input y bot√≥n de generar) */
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem auto;
            max-width: 600px;
            padding: 0 2rem;
            flex-wrap: wrap;
        }
        .input-container { flex: 1; min-width: 300px; position: relative; }
        #promptInput {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        #promptInput:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }
        #promptInput::placeholder { color: rgba(255, 255, 255, 0.5); }
        
        /* Estilos de Botones */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary { background: var(--gradient); color: white; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); }
        .btn-primary:hover { box-shadow: 0 6px 30px rgba(99, 102, 241, 0.6); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--light); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4); }
        .btn-warning { background: var(--warning); color: white; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4); }
        .btn-info { background: var(--info); color: white; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); }
        .btn.small-btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }

        /* Opciones de Visualizaci√≥n */
        .options { display: flex; gap: 1rem; justify-content: center; margin: 1rem auto; padding: 0 2rem; flex-wrap: wrap; }
        .option-group { display: flex; gap: 0.5rem; align-items: center; background: rgba(255, 255, 255, 0.05); padding: 0.5rem 1rem; border-radius: 25px; backdrop-filter: blur(10px); }
        .option-group label { font-size: 0.9rem; color: #a5b4fc; }
        select { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; cursor: pointer; }
        select option { background: var(--dark); }

        /* Contenedor del Mapa Mental */
        #mindmap {
            width: calc(100% - 4rem);
            height: 60vh;
            margin: 1.5rem auto;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        #mindmap::after {
            content: 'Ingresa un tema y genera tu mapa mental\n\nüí° Tip: Doble clic para editar nodos\nüñ±Ô∏è Clic derecho para m√°s opciones';
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(165, 180, 252, 0.3);
            font-size: 1.2rem; text-align: center;
            pointer-events: none; opacity: 1; transition: opacity 0.3s ease;
            white-space: pre-line; line-height: 1.6; z-index: 1;
        }
        #mindmap.has-content::after { opacity: 0; }
        #mindmap:not(.has-content) .vis-network { display: none; }

        /* Botones de Acci√≥n Debajo del Mapa */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem auto;
            flex-wrap: wrap;
        }
        
        /* Men√∫ Contextual (Clic Derecho) */
        .context-menu {
            position: fixed; background: rgba(30, 27, 75, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--primary);
            border-radius: 10px; padding: 0.5rem 0; z-index: 1000;
            display: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 220px;
        }
        .context-menu-item {
            padding: 0.7rem 1.2rem; cursor: pointer; color: var(--light);
            display: flex; align-items: center; gap: 0.75rem;
            transition: background 0.2s ease; font-size: 0.9rem;
        }
        .context-menu-item:hover { background: rgba(99, 102, 241, 0.2); }
        .context-menu-item.danger:hover { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }

        /* Indicador de Selecci√≥n */
        .selection-indicator {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;
            color: #a5b4fc; border: 1px solid rgba(255, 255, 255, 0.2);
            display: none; animation: slideIn 0.5s ease-out; z-index: 999;
        }
        .selection-indicator.show { display: block; }
        
        /* Indicador de Carga (Spinner) */
        .loading {
            display: none; align-items: center; justify-content: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 15, 35, 0.7); backdrop-filter: blur(5px);
            z-index: 2000;
        }
        .loading-spinner {
            width: 60px; height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Input de archivo oculto para importaci√≥n */
        #importFileInput { display: none; }
        
        /* Estilos para el modal de ayuda y config */
        .swal-content-container {
            text-align: left; padding: 0 1rem;
        }
        .swal-content-container h2 {
            color: var(--accent); margin-top: 1.5rem; margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--secondary); padding-bottom: 0.3rem;
        }
        .swal-content-container ul { list-style-position: inside; padding-left: 0.5rem; }
        .swal-content-container li { margin-bottom: 0.5rem; line-height: 1.4; }
        .swal-content-container code {
            background-color: rgba(255,255,255,0.1); padding: 0.2em 0.4em;
            border-radius: 3px; font-family: monospace;
        }
        .swal-content-container a { color: var(--accent); text-decoration: none; }
        .swal-content-container a:hover { text-decoration: underline; }
        .api-key-input-group { margin-bottom: 1rem; }
        .api-key-input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary); }
        .swal2-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            color: white;
            border: 1px solid var(--secondary);
            border-radius: 5px;
        }
        
        /* Estilos de la librer√≠a Vis.js */
        .vis-network{position:relative;overflow:hidden;touch-action:pan-y}
        .vis-network *{box-sizing:border-box}
        .vis-network canvas{position:relative;left:0;top:0;height:100%;width:100%;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;touch-action:pan-y}
        .vis-network canvas:focus{outline:0}
        .vis-network .vis-zoom-and-pan-buttons{position:absolute;bottom:0;left:0;z-index:1}
        .vis-network .vis-zoom-and-pan-buttons button{display:inline-block;width:34px;height:34px;font-size:24px;background-color:#fff;border:none;border-radius:0 3px 0 0;cursor:pointer}
        .vis-network .vis-zoom-and-pan-buttons button:hover{background-color:#eee}
        .vis-network .vis-tooltip{position:absolute;visibility:hidden;padding:5px;white-space:nowrap;font-family:verdana;font-size:14px;color:#000;background-color:#fff;border:1px solid #868686;border-radius:3px;box-shadow:2px 2px 10px rgba(134,134,134,.4);pointer-events:none;z-index:5}
        .vis-network .vis-manipulation{position:absolute;top:0;left:0;z-index:2}
        .vis-network .vis-manipulation .vis-button{display:inline-block;width:34px;height:34px;font-family:fontawesome;font-size:24px;text-align:center;color:#333;background-color:#fff;border:none;border-bottom:1px solid #ccc;cursor:pointer}
        .vis-network .vis-manipulation .vis-button:hover{box-shadow:0 0 3px 3px #eee}
        .vis-network .vis-manipulation .vis-button.vis-selected{background-color:#eee}
        .vis-network .vis-manipulation .vis-button.vis-add{border-radius:3px 0 0}
        .vis-network .vis-manipulation .vis-button.vis-delete{border-radius:0 3px 0 0}
        .vis-network .vis-manipulation .vis-button.vis-back{border-radius:3px}
        .vis-network .vis-manipulation .vis-label{display:inline-block;margin-left:10px}
        .vis-network .vis-manipulation .vis-separator-line{display:inline-block;width:1px;height:25px;margin:5px;background-color:#ccc}
        .vis-network .vis-edit-mode .vis-label{display:inline-block;margin-left:10px}
        .vis-network .vis-edit-mode .vis-button{width:auto;padding:5px 10px;border-radius:3px}
        .vis-network .vis-close{position:absolute;top:0;right:0;width:34px;height:34px;font-family:fontawesome;font-size:24px;text-align:center;color:#333;background-color:#fff;border:none;border-radius:0 0 0 3px;cursor:pointer}
        .vis-network .vis-close:hover{box-shadow:0 0 3px 3px #eee}
        div.vis-network-tooltip{font-family:sans-serif}
        table.vis-network-tooltip{border-collapse:collapse}
        table.vis-network-tooltip,table.vis-network-tooltip td{border:0 solid #d3d3d3;margin:0;padding:3px}
        .vis-network-tooltip-header{font-weight:700}
        div.vis-navigation div.vis-button{position:absolute;font-family:fontawesome;color:#555;font-size:35px;cursor:pointer;display:inline-block;width:50px;height:50px;text-align:center;padding:5px;border-radius:50px}
        div.vis-navigation div.vis-button:hover{box-shadow:0 0 10px 10px rgba(150,150,150,.2)}
        div.vis-navigation div.vis-button:active{box-shadow:0 0 10px 10px rgba(150,150,150,.4)}
        div.vis-navigation div.vis-button.vis-up{bottom:50px;left:50%;margin-left:-25px}
        div.vis-navigation div.vis-button.vis-down{bottom:0;left:50%;margin-left:-25px}
        div.vis-navigation div.vis-button.vis-left{bottom:25px;left:50%;margin-left:-75px}
        div.vis-navigation div.vis-button.vis-right{bottom:25px;left:50%;margin-left:25px}
        div.vis-navigation div.vis-button.vis-zoom-in{bottom:0;right:0}
        div.vis-navigation div.vis-button.vis-zoom-out{bottom:0;right:50px}
        div.vis-navigation div.vis-button.vis-zoom-extents{bottom:100px;left:50%;margin-left:-25px}
        .vis-configuration-wrapper{position:absolute;bottom:0;left:0;right:0;font-family:sans-serif;background:#fff;padding:10px;border:1px solid #d3d3d3;box-shadow:2px 2px 20px rgba(134,134,134,.4)}
        .vis-configuration-wrapper .vis-config-header{font-weight:700;font-size:16px;padding-bottom:10px;border-bottom:1px solid #d3d3d3}
        .vis-configuration-wrapper .vis-config-item{padding-top:10px}
        .vis-configuration-wrapper .vis-config-item>input[type=checkbox]{display:inline-block}
        .vis-configuration-wrapper .vis-config-item>input[type=range],.vis-configuration-wrapper .vis-config-item>label{display:inline-block;padding-left:10px}
        .vis-configuration-wrapper .vis-config-item .vis-config-rangeinput{width:100px}
        .vis-configuration-wrapper .vis-config-item .vis-config-colorinput{width:50px}
        .vis-configuration-wrapper .vis-config-item.vis-config-range>label:after{content:attr(data-value)}
        .vis-configuration-wrapper .vis-config-item .vis-config-button{margin-left:10px}
        .vis-configuration-wrapper .vis-config-item .vis-config-select{display:inline-block;margin-left:10px}
        .vis-configuration-wrapper .vis-config-item .vis-config-label{padding-right:10px}

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 2.2rem; }
            #mindmap { height: 55vh; width: calc(100% - 2rem); }
            .controls, .options, .action-buttons { padding: 0 1rem; }
            .btn { padding: 0.8rem 1.5rem; font-size: 0.9rem; }
            .help-btn { top: 1rem; right: 1rem; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <header class="header">
        <h1>MindFlow Pro</h1>
        <p>Transforma tus ideas en mapas mentales con IA</p>
        <button class="btn btn-info small-btn help-btn" onclick="showHelpModal()">‚ùì Ayuda</button>
    </header>
    
    <div class="controls">
        <div class="input-container">
            <input type="text" id="promptInput" placeholder="Ingresa tu idea central (ej: La c√©lula y sus partes)">
        </div>
        <button class="btn btn-primary" onclick="generateMindMap()">
            ‚ö° Generar MindFlow
        </button>
    </div>
    
    <div class="options">
        <div class="option-group">
            <label for="aiProvider">Proveedor IA:</label>
            <select id="aiProvider">
                <option value="gemini">Google (Gemini)</option>
                <option value="mistral">Mistral</option>
                <option value="deepseek">DeepSeek</option>
                <option value="openrouter">OpenRouter</option>
            </select>
        </div>
        <div class="option-group">
            <label for="themeSelect">Tema:</label>
            <select id="themeSelect" onchange="updateTheme()">
                <option value="cosmic">C√≥smico</option>
                <option value="nature">Natural</option>
                <option value="tech">Tecnol√≥gico</option>
                <option value="minimal">Minimalista</option>
            </select>
        </div>
        <div class="option-group">
            <label for="layoutSelect">Disposici√≥n:</label>
            <select id="layoutSelect" onchange="updateLayout()">
                <option value="hierarchical">Jer√°rquico</option>
                <option value="radial">Radial</option>
            </select>
        </div>
    </div>
    
    <div id="mindmap"></div>
    
    <div class="action-buttons">
        <button class="btn btn-success small-btn" onclick="addNode()">‚ûï A√±adir Nodo</button>
        <button class="btn btn-secondary small-btn" onclick="document.getElementById('importFileInput').click()">üìÇ Importar</button>
        <button class="btn btn-secondary small-btn" onclick="exportJSON()">üíæ Exportar</button>
        <button class="btn btn-secondary small-btn" onclick="exportPNG()">üì∑ Capturar</button>
        <button class="btn btn-danger small-btn" onclick="resetMap()">üîÑ Reiniciar</button>
    </div>
    
    <!-- Men√∫ contextual (inicialmente oculto) -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="addNode()">‚ûï A√±adir Nodo</div>
        <div class="context-menu-item" onclick="editSelectedNode()">‚úèÔ∏è Editar Nodo</div>
        <div class="context-menu-item" onclick="addChildNode()">‚ûï A√±adir Hijo</div>
        <div class="context-menu-item" onclick="expandNodeWithAI()">üß† Expandir con IA</div>
        <div class="context-menu-item" onclick="addIconToNode()">üôÇ A√±adir Icono/Emoji</div>
        <div class="context-menu-item danger" onclick="deleteSelectedNode()">üóëÔ∏è Eliminar</div>
    </div>
    
    <div class="loading"><div class="loading-spinner"></div></div>
    <div class="selection-indicator" id="selectionIndicator"></div>
    <input type="file" id="importFileInput" accept=".json" onchange="handleFileImport(event)">
    
    <script>
        // --- VARIABLES GLOBALES Y ESTADO DE LA APLICACI√ìN ---
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let nodeIdCounter = 0;
        let selectedNode = null;
        
        // --- TEMAS Y CONFIGURACI√ìN VISUAL ---
        const themes = {
            cosmic: { node: { background: '#6366f1', border: '#818cf8', font: '#ffffff' }, edge: { color: '#818cf8', highlight: '#c084fc' } },
            nature: { node: { background: '#10b981', border: '#34d399', font: '#ffffff' }, edge: { color: '#34d399', highlight: '#6ee7b7' } },
            tech: { node: { background: '#f59e0b', border: '#fbbf24', font: '#1f2937' }, edge: { color: '#fbbf24', highlight: '#fde68a' } },
            minimal: { node: { background: '#e5e7eb', border: '#9ca3af', font: '#1f2937' }, edge: { color: '#9ca3af', highlight: '#6b7280' } }
        };
        let currentTheme = themes.cosmic;

        // --- INICIALIZACI√ìN Y EVENTOS DE RED ---
        function initNetwork() {
            const container = document.getElementById('mindmap');
            const data = { nodes, edges };
            const options = {
                nodes: {
                    shape: 'box', borderWidth: 2, borderWidthSelected: 3,
                    font: { size: 16, face: 'Segoe UI, Arial, sans-serif' },
                    shadow: { enabled: true, size: 10, x: 5, y: 5 },
                    mass: 1.5,
                    margin: { top: 10, right: 15, bottom: 10, left: 15 }
                },
                edges: {
                    width: 2,
                    smooth: { type: 'dynamic' },
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                    shadow: true
                },
                layout: {
                    hierarchical: { enabled: true, direction: 'UD', sortMethod: 'directed', nodeSpacing: 150, levelSeparation: 150 }
                },
                physics: {
                    enabled: true,
                    hierarchicalRepulsion: { nodeDistance: 180 }
                },
                interaction: {
                    hover: true, tooltipDelay: 200, hideEdgesOnDrag: true, selectConnectedEdges: false, navigationButtons: true
                },
                manipulation: { enabled: false }
            };
            network = new vis.Network(container, data, options);
            setupNetworkEvents();
        }

        function setupNetworkEvents() {
            network.on('doubleClick', params => {
                if (params.nodes.length > 0) editNode(params.nodes[0]);
            });
            network.on('oncontext', params => {
                params.event.preventDefault();
                hideContextMenu();
                if (params.nodes.length > 0) {
                    selectedNode = params.nodes[0];
                    network.selectNodes([selectedNode]);
                    showContextMenu(params.event.clientX, params.event.clientY);
                }
            });
            network.on('click', params => {
                hideContextMenu();
                updateSelection(params.nodes);
            });
            network.on('dragEnd', () => saveMapToLocalStorage());
            document.addEventListener('click', e => {
                if (!e.target.closest('.context-menu')) hideContextMenu();
            });
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // --- L√ìGICA DE LA IA (GEMINI, MISTRAL, DEEPSEEK) ---
        
        async function generateMindMap() {
            const userPrompt = document.getElementById('promptInput').value.trim();
            if (!userPrompt) {
                showToast('warning', 'Campo vac√≠o', 'Por favor, ingresa una idea o tema.');
                return;
            }
            
            resetMapData();
            document.querySelector('.loading').style.display = 'flex';
            
            const structuredPrompt = `Eres un experto creando mapas mentales claros y concisos. Basado en el tema central "${userPrompt}", genera una estructura de mapa mental. El mapa debe tener un nodo central (nivel 0), varios nodos principales (nivel 1) y algunos sub-nodos (nivel 2). Devuelve la respuesta EXCLUSIVAMENTE en formato JSON, siguiendo el esquema: {"nodes": [{"id": <number>, "label": "<string>", "level": <number>}], "edges": [{"from": <number>, "to": <number>}]}. El nodo con id 0 debe ser el nodo central. Los IDs deben ser √∫nicos y secuenciales empezando en 0. No incluyas explicaciones ni texto adicional, solo el objeto JSON.`;

            try {
                const mapData = await callSelectedAI(structuredPrompt);
                const themedNodes = mapData.nodes.map(node => ({
                    ...node,
                    ...getNodeColor(node.level),
                    font: { size: node.level === 0 ? 22 : (node.level === 1 ? 16 : 14) },
                    ...(node.level === 0 && {size: 40, borderWidth: 3, mass: 3})
                }));
                
                nodeIdCounter = Math.max(-1, ...themedNodes.map(n => n.id)) + 1;
                nodes.add(themedNodes);
                edges.add(mapData.edges);
                
                document.getElementById('mindmap').classList.add('has-content');
                network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
                showToast('success', '¬°Mapa generado con IA!', 'Tu mapa mental est√° listo.');
                saveMapToLocalStorage();
            } catch (error) {
                console.error("Error al generar el mapa mental:", error);
                showToast('error', 'Error de Generaci√≥n', error.message);
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        async function expandNodeWithAI() {
            if (!selectedNode) return;
            document.querySelector('.loading').style.display = 'flex';
            
            const parentNode = nodes.get(selectedNode);
            const structuredPrompt = `Eres un asistente creativo de mapas mentales. Para el concepto central "${parentNode.label}", genera entre 3 y 5 ideas o sub-temas relacionados para expandirlo. Devuelve la respuesta EXCLUSIVAMENTE en formato JSON con una lista de los nuevos conceptos. El JSON debe seguir el esquema {"nuevas_ideas": [{"label": "<string>"}]}. No incluyas el nodo padre, solo los nuevos hijos.`;

            try {
                const result = await callSelectedAI(structuredPrompt, true);
                const childLevel = (parentNode.level || 0) + 1;
                
                result.nuevas_ideas.forEach(idea => {
                    const childId = nodeIdCounter++;
                    nodes.add({ id: childId, label: idea.label, level: childLevel, ...getNodeColor(childLevel) });
                    edges.add({ from: selectedNode, to: childId });
                });

                showToast('success', 'Nodo expandido', `Se a√±adieron ${result.nuevas_ideas.length} ideas nuevas.`);
                saveMapToLocalStorage();
                network.fit({ nodes: [selectedNode], animation: true });
            } catch (error) {
                 console.error("Error al expandir el nodo:", error);
                showToast('error', 'Error de Expansi√≥n', error.message);
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        // --- ADAPTADOR DE API ---
        async function callSelectedAI(prompt, forExpansion = false) {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = await getApiKey(provider);
            if (!apiKey) throw new Error(`API Key para ${provider} no encontrada.`);

            const schema = forExpansion ? 
                { type: "OBJECT", properties: { "nuevas_ideas": { type: "ARRAY", items: { type: "OBJECT", properties: { "label": { type: "STRING" } }, required: ["label"] } } }, required: ["nuevas_ideas"] } :
                { type: "OBJECT", properties: { "nodes": { type: "ARRAY", items: { type: "OBJECT", properties: { "id": { "type": "NUMBER" }, "label": { "type": "STRING" }, "level": { "type": "NUMBER" } }, required: ["id", "label", "level"] } }, "edges": { type: "ARRAY", items: { type: "OBJECT", properties: { "from": { "type": "NUMBER" }, "to": { "type": "NUMBER" } }, required: ["from", "to"] } } }, required: ["nodes", "edges"] };

            let endpoint = '';
            let payload = {};
            let headers = { 'Content-Type': 'application/json' };

            switch (provider) {
                case 'gemini':
                    endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                    break;
                case 'mistral':
                    endpoint = 'https://api.mistral.ai/v1/chat/completions';
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    payload = { model: "mistral-large-latest", messages: [{ role: "user", content: prompt }], response_format: { type: "json_object" } };
                    break;
                case 'deepseek':
                    // FIX: Route DeepSeek requests through OpenRouter to use OpenRouter keys.
                    endpoint = 'https://openrouter.ai/api/v1/chat/completions';
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    payload = { model: "deepseek/deepseek-chat", messages: [{ role: "user", content: prompt }] };
                    break;
                case 'openrouter':
                    endpoint = 'https://openrouter.ai/api/v1/chat/completions';
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    const modelName = localStorage.getItem('openrouterModelName') || 'google/gemini-flash-1.5'; // Default model
                    payload = { model: modelName, messages: [{ role: "user", content: prompt }] };
                    // OpenRouter doesn't support response_format, so we rely on clear prompting.
                    break;
                default:
                    throw new Error("Proveedor de IA no v√°lido.");
            }

            const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`Error de API de ${provider}: ${errorBody.error?.message || response.statusText}`);
            }

            const result = await response.json();
            let content = '';

            // Extract the JSON content from the response according to the provider's format
            if (provider === 'gemini') {
                content = result.candidates?.[0]?.content?.parts?.[0]?.text;
            } else if (['mistral', 'deepseek', 'openrouter'].includes(provider)) {
                 content = result.choices?.[0]?.message?.content;
            }


            if (!content) throw new Error("Respuesta inesperada o vac√≠a de la API.");
            
            try {
                // Clean the JSON if it's wrapped in markdown code blocks
                const cleanedContent = content.replace(/^```json\s*|```\s*$/g, '');
                return JSON.parse(cleanedContent);
            } catch (e) {
                console.error("Failed to parse JSON, original content:", content);
                throw new Error("La IA no devolvi√≥ un JSON v√°lido.");
            }
        }

        // --- MANIPULACI√ìN DE NODOS Y ARISTAS (MANUAL) ---
        async function addNode() {
            const { value: label } = await Swal.fire({
                title: 'A√±adir Nuevo Nodo',
                input: 'text',
                inputPlaceholder: 'Texto del nuevo nodo...',
                showCancelButton: true,
                confirmButtonText: 'Crear Nodo',
                ...getSwalTheme()
            });

            if (label) {
                const newId = nodeIdCounter++;
                const parentSelection = network.getSelectedNodes();
                const level = parentSelection.length > 0 ? (nodes.get(parentSelection[0]).level || 0) + 1 : 0;
                
                nodes.add({ id: newId, label: label, level: level, ...getNodeColor(level) });

                if (parentSelection.length > 0) {
                    edges.add({ from: parentSelection[0], to: newId });
                }
                
                if (nodes.length === 1) {
                    document.getElementById('mindmap').classList.add('has-content');
                }
                saveMapToLocalStorage();
            }
        }
        
        async function editNode(nodeId) {
            const node = nodes.get(nodeId);
            const { value: newLabel } = await Swal.fire({
                title: 'Editar Nodo', input: 'text', inputValue: node.label,
                showCancelButton: true, confirmButtonText: 'Guardar', ...getSwalTheme()
            });
            if (newLabel && newLabel !== node.label) {
                 nodes.update({ id: nodeId, label: newLabel });
                 saveMapToLocalStorage();
            }
        }
        
        async function addChildNode() {
            if (!selectedNode) return;
            const { value: label } = await Swal.fire({
                title: `A√±adir hijo a "${nodes.get(selectedNode).label}"`, input: 'text', inputPlaceholder: 'Texto del nodo hijo...',
                showCancelButton: true, confirmButtonText: 'A√±adir', ...getSwalTheme()
            });
            if (label) {
                const parentNode = nodes.get(selectedNode);
                const childLevel = (parentNode.level || 0) + 1;
                const childId = nodeIdCounter++;
                nodes.add({ id: childId, label, level: childLevel, ...getNodeColor(childLevel) });
                edges.add({ from: selectedNode, to: childId });
                saveMapToLocalStorage();
            }
        }
        
        function deleteSelectedNodes() {
            const selection = network.getSelection();
            if (selection.nodes.length === 0 && selection.edges.length === 0) {
                showToast('warning', 'Nada seleccionado', 'Selecciona uno o m√°s nodos/aristas.');
                return;
            }
            Swal.fire({
                title: '¬øEst√°s seguro?', text: `Se eliminar√°n ${selection.nodes.length} nodos y sus conexiones.`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                confirmButtonText: 'S√≠, eliminar', cancelButtonText: 'Cancelar', ...getSwalTheme()
            }).then(result => {
                if (result.isConfirmed) {
                    nodes.remove(selection.nodes);
                    if (nodes.length === 0) document.getElementById('mindmap').classList.remove('has-content');
                    saveMapToLocalStorage();
                }
            });
        }
        
        async function addIconToNode() {
            if(!selectedNode) return;
            const node = nodes.get(selectedNode);
            const { value: emoji } = await Swal.fire({
                title: 'A√±adir Icono/Emoji', input: 'text',
                inputPlaceholder: 'Pega un emoji aqu√≠ (ej: ‚ú®)', ...getSwalTheme()
            });
            if (emoji) {
                const plainLabel = node.label.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu, '').trim();
                nodes.update({ id: selectedNode, label: `${emoji} ${plainLabel}` });
                saveMapToLocalStorage();
            }
        }

        function handleKeyboardShortcuts(event) {
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(event.target.tagName)) return;
            switch(event.key) {
                case 'Delete': case 'Backspace':
                    event.preventDefault(); deleteSelectedNodes(); break;
                case 'Escape':
                    network.unselectAll(); break;
                case 'Enter':
                    if (network.getSelectedNodes().length === 1) {
                        event.preventDefault(); editNode(network.getSelectedNodes()[0]);
                    }
                    break;
            }
        }

        // --- PERSISTENCIA Y GESTI√ìN DE DATOS ---
        
        async function getApiKey(provider) {
            // The DeepSeek provider now uses the OpenRouter key
            const keyProvider = provider === 'deepseek' ? 'openrouter' : provider;
            const keyName = `${keyProvider}ApiKey`;
            let apiKey = localStorage.getItem(keyName);
            if (apiKey) return apiKey;

            const { value: inputApiKey } = await Swal.fire({
                title: `Configurar API Key para ${keyProvider.charAt(0).toUpperCase() + keyProvider.slice(1)}`,
                html: `Se necesita una clave de API para usar esta funci√≥n. Se guardar√° en tu navegador.`,
                input: 'password',
                inputPlaceholder: 'Pega tu clave de API aqu√≠',
                confirmButtonText: 'Guardar Clave',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                allowOutsideClick: false,
                ...getSwalTheme(),
                inputValidator: (value) => !value && '¬°Necesitas ingresar una clave de API!'
            });

            if (inputApiKey) {
                localStorage.setItem(keyName, inputApiKey);
                showToast('success', 'Clave guardada', `Ahora puedes usar ${provider}.`);
                return inputApiKey;
            } else {
                showToast('info', 'Funci√≥n cancelada', 'Puedes configurar la clave desde la Ayuda.');
                return null;
            }
        }

        function saveMapToLocalStorage() {
            if (nodes.length > 0) {
                network.storePositions();
                const mapData = {
                    nodes: nodes.get({ fields: ['id', 'label', 'level', 'x', 'y', 'color', 'font'] }),
                    edges: edges.get(),
                    nodeIdCounter: nodeIdCounter
                };
                localStorage.setItem('mindflowData', JSON.stringify(mapData));
            } else {
                localStorage.removeItem('mindflowData');
            }
        }

        function loadMapFromLocalStorage() {
            const savedData = localStorage.getItem('mindflowData');
            if (savedData) {
                try {
                    const mapData = JSON.parse(savedData);
                    nodes.add(mapData.nodes);
                    edges.add(mapData.edges);
                    nodeIdCounter = mapData.nodeIdCounter || (Math.max(-1, ...mapData.nodes.map(n => n.id)) + 1);
                    document.getElementById('mindmap').classList.add('has-content');
                    showToast('info', 'Mapa cargado', 'Se ha restaurado tu sesi√≥n anterior.');
                } catch(e) {
                    console.error("Error al cargar datos locales, reiniciando.", e);
                    localStorage.removeItem('mindflowData');
                }
            }
        }

        function exportJSON() {
            if (nodes.length === 0) return showToast('warning', 'Mapa vac√≠o', 'No hay nada que exportar.');
            network.storePositions();
            const mapData = { nodes: nodes.get(), edges: edges.get(), nodeIdCounter: nodeIdCounter };
            const dataStr = JSON.stringify(mapData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const promptName = document.getElementById('promptInput').value.trim().replace(/\s+/g, '_') || 'mapa_mental';
            link.download = `MindFlow_${promptName}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const mapData = JSON.parse(e.target.result);
                    if (mapData.nodes && mapData.edges) {
                        resetMapData();
                        nodes.add(mapData.nodes);
                        edges.add(mapData.edges);
                        nodeIdCounter = mapData.nodeIdCounter || (Math.max(-1, ...mapData.nodes.map(n => n.id)) + 1);
                        document.getElementById('mindmap').classList.add('has-content');
                        network.fit();
                        showToast('success', 'Mapa importado', 'El mapa se ha cargado correctamente.');
                        saveMapToLocalStorage();
                    } else { throw new Error("Formato de archivo incorrecto."); }
                } catch (error) {
                    console.error("Error al importar JSON:", error);
                    showToast('error', 'Error de importaci√≥n', 'El archivo no es un mapa mental v√°lido.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- PERSONALIZACI√ìN VISUAL ---
        function updateTheme() {
            currentTheme = themes[document.getElementById('themeSelect').value];
            applyThemeToAll();
        }

        function updateLayout() {
            const layout = document.getElementById('layoutSelect').value;
            network.setOptions({
                layout: { hierarchical: { enabled: layout === 'hierarchical' } },
                physics: { 
                    enabled: true,
                    solver: layout === 'radial' ? 'forceAtlas2Based' : 'hierarchicalRepulsion'
                }
            });
        }

        function applyThemeToAll() {
            nodes.forEach(node => {
                nodes.update({ id: node.id, ...getNodeColor(node.level) });
            });
            edges.forEach(edge => {
                edges.update({ id: edge.id, color: { color: currentTheme.edge.color, highlight: currentTheme.edge.highlight } });
            });
            saveMapToLocalStorage();
        }
        
        function getNodeColor(level = 0) {
            const opacities = ['', 'dd', 'aa', '88'];
            const opacity = opacities[level] || '66';
            return {
                color: { background: currentTheme.node.background + opacity, border: currentTheme.node.border },
                font: { color: currentTheme.node.font }
            };
        }

        // --- UTILIDADES Y UI HELPERS ---
        async function showApiConfigModal() {
            const currentDefault = localStorage.getItem('defaultAiProvider') || 'deepseek'; 
            const { value: formValues } = await Swal.fire({
                title: 'Configuraci√≥n de API Keys',
                html: `
                <div class="swal-content-container">
                    <p>Ingresa tus claves de API para cada proveedor. Se guardar√°n en tu navegador.</p>
                    <div class="api-key-input-group">
                        <label for="swal-gemini-key">Google (Gemini)</label>
                        <input id="swal-gemini-key" class="swal2-input" type="password" placeholder="Clave de Google AI Studio" value="${localStorage.getItem('geminiApiKey') || ''}">
                    </div>
                    <div class="api-key-input-group">
                        <label for="swal-mistral-key">Mistral</label>
                        <input id="swal-mistral-key" class="swal2-input" type="password" placeholder="Clave de Mistral AI" value="${localStorage.getItem('mistralApiKey') || ''}">
                    </div>
                     <div class="api-key-input-group">
                        <label for="swal-openrouter-key">OpenRouter / DeepSeek</label>
                        <input id="swal-openrouter-key" class="swal2-input" type="password" placeholder="Pega aqu√≠ tu clave de OpenRouter o DeepSeek" value="${localStorage.getItem('openrouterApiKey') || ''}">
                    </div>
                     <div class="api-key-input-group">
                        <label for="swal-openrouter-model">Modelo de OpenRouter</label>
                        <input id="swal-openrouter-model" class="swal2-input" type="text" placeholder="Ej: deepseek/deepseek-chat" value="${localStorage.getItem('openrouterModelName') || 'deepseek/deepseek-chat'}">
                    </div>
                    <div class="api-key-input-group">
                         <label for="swal-default-provider">Proveedor por Defecto</label>
                         <select id="swal-default-provider" class="swal2-select">
                            <option value="none" ${currentDefault === 'none' ? 'selected' : ''}>Ninguno</option>
                            <option value="gemini" ${currentDefault === 'gemini' ? 'selected' : ''}>Google (Gemini)</option>
                            <option value="mistral" ${currentDefault === 'mistral' ? 'selected' : ''}>Mistral</option>
                            <option value="deepseek" ${currentDefault === 'deepseek' ? 'selected' : ''}>DeepSeek (v√≠a OpenRouter)</option>
                            <option value="openrouter" ${currentDefault === 'openrouter' ? 'selected' : ''}>OpenRouter (modelo personalizado)</option>
                         </select>
                    </div>
                </div>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar Claves',
                ...getSwalTheme(),
                preConfirm: () => {
                    return {
                        gemini: document.getElementById('swal-gemini-key').value,
                        mistral: document.getElementById('swal-mistral-key').value,
                        openrouter: document.getElementById('swal-openrouter-key').value,
                        openrouterModel: document.getElementById('swal-openrouter-model').value,
                        defaultProvider: document.getElementById('swal-default-provider').value
                    }
                }
            });

            if (formValues) {
                // Guarda o borra las claves de API
                localStorage.setItem('geminiApiKey', formValues.gemini || '');
                localStorage.setItem('mistralApiKey', formValues.mistral || '');
                localStorage.setItem('openrouterApiKey', formValues.openrouter || '');
                // DeepSeek usa la clave de OpenRouter, por lo que no se guarda por separado.
                localStorage.setItem('openrouterModelName', formValues.openrouterModel || '');
                
                // Guarda la elecci√≥n del proveedor por defecto
                if (formValues.defaultProvider && formValues.defaultProvider !== 'none') {
                    localStorage.setItem('defaultAiProvider', formValues.defaultProvider);
                    document.getElementById('aiProvider').value = formValues.defaultProvider;
                } else {
                    localStorage.removeItem('defaultAiProvider');
                }
                
                showToast('success', 'Configuraci√≥n guardada.');
            }
        }
        
        function showHelpModal() {
            Swal.fire({
                title: 'Gu√≠a de Ayuda de MindFlow Pro',
                html: `
                    <div class="swal-content-container">
                        <h2>ü§ñ M√∫ltiples Motores de IA</h2>
                        <p>MindFlow ahora te permite elegir tu proveedor de IA preferido. Cada uno tiene sus fortalezas:</p>
                        <ul>
                            <li><strong>Google (Gemini):</strong> R√°pido y confiable, ideal para la mayor√≠a de los casos.</li>
                            <li><strong>Mistral:</strong> Conocido por su razonamiento y coherencia.</li>
                            <li><strong>DeepSeek (v√≠a OpenRouter):</strong> Utiliza el modelo de DeepSeek a trav√©s de la API de OpenRouter.</li>
                            <li><strong>OpenRouter:</strong> Accede a cientos de modelos (incluidos los de OpenAI, Anthropic, etc.) a trav√©s de una sola API.</li>
                        </ul>
                        <h2>üîë Configuraci√≥n de Claves API</h2>
                        <p>Para usar la IA, necesitas una clave (API Key) para cada servicio que quieras usar. La aplicaci√≥n te la pedir√° la primera vez.</p>
                        <ul>
                            <li><a href="#" onclick="Swal.close(); showApiConfigModal();">Gestionar mis claves y proveedor por defecto</a>.</li>
                            <li>Consigue tus claves en: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google</a>, <a href="https://console.mistral.ai/" target="_blank">Mistral</a>, <a href="https://openrouter.ai/keys" target="_blank">OpenRouter</a>.</li>
                        </ul>
                        <h2>‚úçÔ∏è Edici√≥n y Controles</h2>
                        <ul>
                            <li><strong>Doble Clic:</strong> Edita el texto de un nodo.</li>
                            <li><strong>Clic Derecho:</strong> Abre el men√∫ para expandir con IA, a√±adir hijos, iconos y m√°s.</li>
                        </ul>
                        <h2>üíæ Importar y Exportar</h2>
                        <p>Usa los botones para guardar tus mapas como archivos <code>.json</code> para tener copias de seguridad o compartirlos, y para exportarlos como im√°genes <code>.png</code>.</p>
                    </div>`,
                width: '80%',
                ...getSwalTheme()
            });
        }

        function exportPNG() {
            if (nodes.length === 0) return showToast('warning', 'Mapa vac√≠o', 'No hay nada que exportar.');
            showToast('info', 'Exportando...', 'Generando imagen PNG, por favor espera.');
            html2canvas(document.querySelector('#mindmap canvas'), {
                backgroundColor: '#0f0f23', scale: 2, logging: false, useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `MindFlow-${document.getElementById('promptInput').value || 'map'}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error("Error al exportar a PNG:", err);
                showToast('error', 'Error de Exportaci√≥n', 'No se pudo generar la imagen.');
            });
        }
        
        function resetMapData() {
            nodes.clear(); edges.clear(); nodeIdCounter = 0;
            document.getElementById('mindmap').classList.remove('has-content');
        }

        function resetMap() {
            Swal.fire({
                title: '¬øReiniciar Mapa?', text: "Se perder√° todo el mapa actual. Esta acci√≥n no se puede deshacer.",
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                confirmButtonText: 'S√≠, reiniciar', cancelButtonText: 'Cancelar', ...getSwalTheme()
            }).then(result => {
                if (result.isConfirmed) {
                    resetMapData();
                    localStorage.removeItem('mindflowData');
                    document.getElementById('promptInput').value = '';
                }
            });
        }

        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${x}px`; menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            selectedNode = null;
        }

        function updateSelection(nodeIds) {
            const indicator = document.getElementById('selectionIndicator');
            if (nodeIds.length > 0) {
                const nodeText = nodeIds.length === 1 ? `"${nodes.get(nodeIds[0]).label}"` : `${nodeIds.length} nodos`;
                indicator.textContent = `Seleccionado: ${nodeText}`;
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }
        
        function editSelectedNode() { if (selectedNode) editNode(selectedNode); }
        function deleteSelectedNode() { if (selectedNode) { network.selectNodes([selectedNode]); deleteSelectedNodes(); } }
        
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
        function showToast(icon, title, text = '') { Toast.fire({ icon, title, text, background: '#1e1b4b', color: '#f8fafc' }); }
        function getSwalTheme() { return { background: '#1e1b4b', color: '#f8fafc', confirmButtonColor: '#6366f1', cancelButtonColor: '#6b7280' }; }
        
        // --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
        window.onload = () => {
            initNetwork();
            // Establece DeepSeek (via OpenRouter) como el proveedor por defecto al cargar.
            localStorage.setItem('defaultAiProvider', 'deepseek');
            document.getElementById('aiProvider').value = 'deepseek';
            
            // Si no hay clave de OpenRouter, pre-llena la que proporcionaste.
            if (!localStorage.getItem('openrouterApiKey')) {
                localStorage.setItem('openrouterApiKey', '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');
            }
            
            loadMapFromLocalStorage();
            document.getElementById('promptInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') generateMindMap();
            });
        };
    </script>
</body>
</html>
